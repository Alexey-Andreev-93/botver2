// –ò–º–ø–æ—Ä—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
import * as dotenv from "dotenv";
dotenv.config();

import { Telegraf } from "telegraf";
import { initDatabase } from "./database";
import { Order } from "./models/Order";
import { userStateService } from "./services/UserStateService";
import { ValidationService } from "./services/ValidationService";
import { Logger } from "./utils/logger";
import { CONSTANTS } from "./config/constants";

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞
const BOT_TOKEN = process.env.BOT_TOKEN || "";
if (BOT_TOKEN === "") {
  Logger.error("–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è BOT_TOKEN –Ω–µ –∑–∞–¥–∞–Ω–∞!");
  process.exit(1);
}

// –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–æ—Ç–∞
const bot = new Telegraf(BOT_TOKEN);

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
bot.start((ctx) => {
  const menuKeyboard = {
    keyboard: [
      ["üìã –ú–µ–Ω—é", "üõí –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –æ–±–µ–¥"],
      ["üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã", "‚ùì –ü–æ–º–æ—â—å"],
    ],
    resize_keyboard: true,
  };

  ctx.reply(CONSTANTS.MESSAGES.WELCOME, { reply_markup: menuKeyboard });
  Logger.info(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${ctx.from?.id} –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞`);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ú–µ–Ω—é"
// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ú–µ–Ω—é"
bot.hears("üìã –ú–µ–Ω—é", (ctx) => {
  const menuText = `
üç∞ *–ú–ï–î–û–í–ò–ö–ò* üçØ

üçØ –ú–µ–¥–æ–≤–∏–∫ —Ä–∞–∑–Ω–æ—Ç—Ä–∞–≤—å–µ \\- 189‚ÇΩ
*–ù–µ–∂–Ω—ã–π —Ç–æ—Ä—Ç —Å –º–µ–¥–æ–º —Ä–∞–∑–Ω–æ—Ç—Ä–∞–≤—å—è*

üåæ –ú–µ–¥–æ–≤–∏–∫ –≥—Ä–µ—á–∏—à–Ω—ã–π \\- 199‚ÇΩ 
*–° –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–º –≤–∫—É—Å–æ–º –≥—Ä–µ—á–∏—à–Ω–æ–≥–æ –º–µ–¥–∞*

üå∞ –ú–µ–¥–æ–≤–∏–∫ –∫–∞—à—Ç–∞–Ω–æ–≤—ã–π \\- 229‚ÇΩ
*–° –±–ª–∞–≥–æ—Ä–æ–¥–Ω—ã–º –∫–∞—à—Ç–∞–Ω–æ–≤—ã–º –º–µ–¥–æ–º*

ü´ê –ú–µ–¥–æ–≤–∏–∫ —Å –±—Ä—É—Å–Ω–∏–∫–æ–π \\- 219‚ÇΩ
*–°–ª–∞–¥–∫–∏–π –º–µ–¥ –∏ –∫–∏—Å–ª–∏–Ω–∫–∞ –±—Ä—É—Å–Ω–∏–∫–∏*

üåø –ú–µ–¥–æ–≤–∏–∫ —Å –∞–ª–æ—ç \\- 229‚ÇΩ
*–û—Å–≤–µ–∂–∞—é—â–∏–π —Å —ç–∫—Å—Ç—Ä–∞–∫—Ç–æ–º –∞–ª–æ—ç*

ü•≠ –ú–µ–¥–æ–≤–∏–∫ –º–∞–Ω–≥–æ\\-–æ–±–ª–µ–ø–∏—Ö–∞ \\- 219‚ÇΩ
*–¢—Ä–æ–ø–∏—á–µ—Å–∫–∏–π –º–∏–∫—Å –º–∞–Ω–≥–æ –∏ –æ–±–ª–µ–ø–∏—Ö–∏*

üçì –ú–µ–¥–æ–≤–∏–∫ –º–∞–ª–∏–Ω–∞\\-—Ñ–∏—Å—Ç–∞—à–∫–∞ \\- 259‚ÇΩ
*–ù–µ–∂–Ω–∞—è –º–∞–ª–∏–Ω–∞ –∏ —Ö—Ä—É—Å—Ç—è—â–∞—è —Ñ–∏—Å—Ç–∞—à–∫–∞*

üç¶ –ú–µ–¥–æ–≤–∏–∫ –ë–µ–π–ª–∏—Å\\-—á–∏–∑–∫–µ–π–∫ \\- 239‚ÇΩ
*–° –∏–∑—ã—Å–∫–∞–Ω–Ω—ã–º –≤–∫—É—Å–æ–º –ë–µ–π–ª–∏—Å–∞*

üçé –ú–µ–¥–æ–≤–∏–∫ —è–±–ª–æ–∫–æ\\-–≥—Ä–µ—Ü–∫–∏–π –æ—Ä–µ—Ö \\- 229‚ÇΩ
*–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ —Å–æ—á–µ—Ç–∞–Ω–∏–µ —Å –æ—Ä–µ—Ö–∞–º–∏*

üéÇ *–¢–û–†–¢–´ –ò –ü–ò–†–û–ñ–ù–´–ï* 

üç∞ –ù–∞–ø–æ–ª–µ–æ–Ω —Å –∑–∞–≤–∞—Ä–Ω—ã–º –∫—Ä–µ–º–æ–º \\- 220‚ÇΩ
*–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Å –Ω–µ–∂–Ω—ã–º –∑–∞–≤–∞—Ä–Ω—ã–º –∫—Ä–µ–º–æ–º*

ü´ê –ù–∞–ø–æ–ª–µ–æ–Ω –ª–µ—Å–Ω—ã–µ —è–≥–æ–¥—ã \\- 240‚ÇΩ
*–° —Å–≤–µ–∂–∏–º–∏ –ª–µ—Å–Ω—ã–º–∏ —è–≥–æ–¥–∞–º–∏*

ü•î –ö–∞—Ä—Ç–æ—à–∫–∞ —Å –∞–º–∞—Ä–µ—Ç—Ç–æ \\- 90‚ÇΩ
*–®–æ–∫–æ–ª–∞–¥–Ω–æ–µ –ø–∏—Ä–æ–∂–Ω–æ–µ —Å –∞–º–∞—Ä–µ—Ç—Ç–æ*

üç´ –°–Ω–∏–∫–µ—Ä—Å \\- 135‚ÇΩ
*–ê—Ä–∞—Ö–∏—Å, –Ω—É–≥–∞, –∫–∞—Ä–∞–º–µ–ª—å –∏ —à–æ–∫–æ–ª–∞–¥*

üå∫ –ú–∞—Ä–∞–∫—É–π—è –≤ –º–æ–ª–æ—á–Ω–æ–º —à–æ–∫–æ–ª–∞–¥–µ \\- 230‚ÇΩ
*–≠–∫–∑–æ—Ç–∏—á–µ—Å–∫–∞—è –º–∞—Ä–∞–∫—É–π—è –≤ —à–æ–∫–æ–ª–∞–¥–µ*

üçí –®–æ–∫–æ–ª–∞–¥–Ω—ã–π –ø–∏—Ä–æ–≥\\-—á–∏–∑–∫–µ–π–∫ —Å –≤–∏—à–Ω–µ–π \\- 195‚ÇΩ
*–®–æ–∫–æ–ª–∞–¥–Ω—ã–π —á–∏—Å–∫–µ–π–∫ —Å –≤–∏—à–Ω–µ–≤–æ–π –Ω–∞—á–∏–Ω–∫–æ–π*

üçì –ú–µ—Ä–µ–Ω–≥–æ–≤—ã–π —Ä—É–ª–µ—Ç —Å –º–∞–ª–∏–Ω–æ–π, —Ñ–∏—Å—Ç–∞—à–∫–æ–π –∏ –º–∞—Å–∫–∞—Ä–ø–æ–Ω–µ \\- 280‚ÇΩ/100–≥—Ä
*–í–æ–∑–¥—É—à–Ω—ã–π —Ä—É–ª–µ—Ç —Å –Ω–µ–∂–Ω–æ–π –Ω–∞—á–∏–Ω–∫–æ–π*

üçΩ *–ö–û–ú–ü–õ–ï–ö–°–ù–´–ï –û–ë–ï–î–´*

ü•ó –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –æ–±–µ–¥ \\- 350‚ÇΩ
*–°—É–ø \\+ —Å–∞–ª–∞—Ç \\+ –æ—Å–Ω–æ–≤–Ω–æ–µ –±–ª—é–¥–æ \\+ —Ö–ª–µ–±*

‚òï *–ù–ê–ü–ò–¢–ö–ò* \\(–¥–æ–±–∞–≤—è—Ç—Å—è —Å–∫–æ—Ä–æ\\!\\)

_–ß—Ç–æ–±—ã –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å, –Ω–∞–∂–º–∏—Ç–µ_ üëá
`;

  ctx.replyWithMarkdownV2(menuText);
  Logger.debug(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${ctx.from?.id} –∑–∞–ø—Ä–æ—Å–∏–ª –º–µ–Ω—é`);
});

// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –æ–±–µ–¥"
bot.hears("üõí –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –æ–±–µ–¥", (ctx) => {
  const userId = ctx.from?.id;
  if (!userId) return;

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  userStateService.setState(userId, {
    state: "awaiting_name",
    data: {},
  });

  ctx.reply("–û—Ç–ª–∏—á–Ω–æ! –î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±–µ–¥–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ –∏–º—è:");
  Logger.info(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –Ω–∞—á–∞–ª –ø—Ä–æ—Ü–µ—Å—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è`);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ö–æ–Ω—Ç–∞–∫—Ç—ã"
bot.hears("üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã", (ctx) => {
  const contactText = `
üìç –ù–∞—à –∞–¥—Ä–µ—Å: –£–ª–∏—Ü–∞ –ü—É—à–∫–∏–Ω–∞, –¥–æ–º –ö–æ–ª–æ—Ç—É—à–∫–∏–Ω–∞
üïí –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: 9:00 - 21:00 –±–µ–∑ –≤—ã—Ö–æ–¥–Ω—ã—Ö
üì± –¢–µ–ª–µ—Ñ–æ–Ω: +7 (XXX) XXX-XX-XX
üåê –°–∞–π—Ç: cafe-sweet-bake.ru
  `;
  ctx.reply(contactText);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ü–æ–º–æ—â—å"
bot.hears("‚ùì –ü–æ–º–æ—â—å", (ctx) => {
  const helpText = `
–Ø –±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –∫–∞—Ñ–µ "Sweet Bake"!

–í–æ—Ç —á—Ç–æ —è —É–º–µ—é:
‚Ä¢ –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –º–µ–Ω—é üçΩ
‚Ä¢ –ü—Ä–∏–Ω–∏–º–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±–µ–¥–æ–≤ üõí
‚Ä¢ –°–æ–æ–±—â–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ –∞–¥—Ä–µ—Å üìû

–ü—Ä–æ—Å—Ç–æ –Ω–∞–∂–∏–º–∞–π—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞!
  `;
  ctx.reply(helpText);
});

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–æ–µ–≥–æ ID
bot.command("id", (ctx) => {
  const userId = ctx.from?.id;
  ctx.reply(`–í–∞—à ID: ${userId}`);
  Logger.info(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª ID: ${userId}`);
});

// –ê–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–∫–∞–∑–æ–≤
bot.command("orders", async (ctx) => {
  const userId = ctx.from?.id;

  if (userId !== CONSTANTS.BOT.ADMIN_ID) {
    Logger.warn(
      `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –ø–æ–ø—ã—Ç–∞–ª—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥–µ`
    );
    return ctx.reply(CONSTANTS.MESSAGES.NO_ACCESS);
  }

  try {
    const orders = await Order.findAll({
      order: [["created_at", "DESC"]],
      limit: 10,
    });

    if (orders.length === 0) {
      Logger.info("–ê–¥–º–∏–Ω –∑–∞–ø—Ä–æ—Å–∏–ª –∑–∞–∫–∞–∑—ã - –∑–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç");
      return ctx.reply(CONSTANTS.MESSAGES.NO_ORDERS);
    }

    let ordersText = "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã:\n\n";

    orders.forEach((order) => {
      ordersText += `#${order.id} ‚Ä¢ ${order.user_name}\n`;
      ordersText += `üìû ${order.user_phone || "–Ω–µ —É–∫–∞–∑–∞–Ω"}\n`;
      ordersText += `üçΩ ${order.items}\n`;
      ordersText += `üí∞ ${order.total_amount} —Ä—É–±.\n`;
      ordersText += `üìä –°—Ç–∞—Ç—É—Å: ${order.status}\n`;
      ordersText += `üïí ${order.created_at.toLocaleString("ru-RU")}\n`;
      ordersText += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    });

    // –†–∞–∑–±–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ
    if (ordersText.length > 4000) {
      ordersText =
        ordersText.substring(0, 4000) + "\n... (–ø–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 4000 —Å–∏–º–≤–æ–ª–æ–≤)";
    }

    ctx.reply(ordersText);
    Logger.info(`–ê–¥–º–∏–Ω –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–ª ${orders.length} –∑–∞–∫–∞–∑–æ–≤`);
  } catch (error) {
    Logger.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤:", error);
    ctx.reply(CONSTANTS.MESSAGES.ORDERS_ERROR);
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
bot.on("text", async (ctx) => {
  const userId = ctx.from?.id;
  const messageText = ctx.message.text;

  if (!userId) return;

  // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã (–æ–Ω–∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å /)
  if (messageText.startsWith("/")) {
    return;
  }

  // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
  if (CONSTANTS.BOT.IGNORED_TEXTS.includes(messageText)) {
    return;
  }

  const userState = userStateService.getState(userId);

  if (userState?.state === "awaiting_name") {
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω–∏
    const validation = ValidationService.isValidName(messageText);
    if (!validation.isValid) {
      ctx.reply(validation.message || "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è");
      return;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω
    userStateService.updateState(userId, {
      state: "awaiting_phone",
      data: { name: messageText.trim() },
    });

    ctx.reply("–°–ø–∞—Å–∏–±–æ! –¢–µ–ø–µ—Ä—å —É–∫–∞–∂–∏—Ç–µ –≤–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏:");
    Logger.info(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –≤–≤–µ–ª –∏–º—è: ${messageText}`);
  } else if (userState?.state === "awaiting_phone") {
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    const validation = ValidationService.isValidPhone(messageText);
    if (!validation.isValid) {
      ctx.reply(validation.message || "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω");
      return;
    }

    const formattedPhone = ValidationService.formatPhone(messageText);

    try {
      // –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
      const order = await Order.create({
        user_id: userId,
        user_name: userState.data.name!,
        user_phone: formattedPhone,
        items: CONSTANTS.ORDER.DEFAULT_ITEMS,
        total_amount: CONSTANTS.ORDER.DEFAULT_AMOUNT,
        status: CONSTANTS.ORDER.STATUS.NEW,
      });

      // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      userStateService.clearState(userId);

      ctx.reply(
        `üéâ *–°–ø–∞—Å–∏–±–æ, ${userState.data.name}!*\n\n–í–∞—à –∑–∞–∫–∞–∑ #${order.id} –ø—Ä–∏–Ω—è—Ç! üìã\n–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É ${formattedPhone} –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è üìû\n\n_–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ: ${order.total_amount}‚ÇΩ_`
      );

      Logger.success(
        `–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ #${order.id} –æ—Ç ${userState.data.name} (${userId})`
      );
    } catch (error) {
      Logger.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞:", error);
      ctx.reply(CONSTANTS.MESSAGES.ORDER_ERROR);
    }
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –±–æ—Ç–∞
bot.catch((error, ctx) => {
  Logger.error("–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –±–æ—Ç–∞:", error);
  ctx.reply("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
});

// –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
async function startBot() {
  try {
    // –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    await initDatabase();
    Logger.success("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞");

    // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    userStateService.cleanupOldStates();

    // –ó–∞—Ç–µ–º –∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    await bot.launch();
    Logger.success("–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!");

    console.log("\nüìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:");
    console.log("‚Ä¢ /start - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é");
    console.log("‚Ä¢ /id - –£–∑–Ω–∞—Ç—å —Å–≤–æ–π Telegram ID");
    console.log("‚Ä¢ /orders - –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–∫–∞–∑–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)");
    console.log("\n‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏");
    console.log("‚úÖ –û–∂–∏–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...");
  } catch (error) {
    Logger.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞:", error);
    process.exit(1);
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
startBot();

// –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
process.once("SIGINT", () => {
  Logger.info("–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...");
  bot.stop("SIGINT");
  process.exit(0);
});

process.once("SIGTERM", () => {
  Logger.info("–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...");
  bot.stop("SIGTERM");
  process.exit(0);
});
